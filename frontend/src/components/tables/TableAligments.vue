<template>
  <div v-if="integrationStore.chargingAlignments" class="center">
    <q-spinner-pie v-if="integrationStore.chargingAlignments" color="primary" size="25em" align="center"/>
  </div>
  <q-table v-else :rows="integrationStore.alignments" :columns="columns" :class="{ 'no-shadow': no_shadow }"
           :visible-columns="visibleCols" id="TableAlignments"
           row-key="uriA"
           virtual-scroll
           :rows-per-page-options="[0]"
           style="height: 60vh"
           v-model:pagination="pagination"
           no-data-label="Consider adding some alignments to start the integration process"
           no-results-label="The filter didn't uncover any results">
    <template v-slot:top-left="">
      <div class="q-table__title">
        <span> {{ title }}  </span>
        <!-- <q-btn padding="none" color="secondary" icon="add" @click="show_dialog = true"/> -->
        <q-btn-dropdown color="primary" dropdown-icon="add" no-icon-animation padding="none" menu-anchor="top right"
                        menu-self="top left">
          <q-list>
            <!-- style="cursor: not-allowed !important" -->
            <!-- @click="setManualView('manual') -->
            <q-item clickable v-close-popup @click="setManualView('manual')">
              <q-item-section>
                <q-item-label>Manual alignment</q-item-label>
              </q-item-section>
            </q-item>

            <q-item clickable v-close-popup @click="getAutomaticAlignments">
              <q-item-section>
                <q-item-label>Automatic alignments</q-item-label>
              </q-item-section>
            </q-item>

            <!-- <q-item clickable v-close-popup @click="setManualView">
              <q-item-section>
                <q-item-label>Add using AlignAPI</q-item-label>
              </q-item-section>
            </q-item> -->
          </q-list>
        </q-btn-dropdown>
      </div>
    </template>

    <template v-slot:top-right="props">

      <!--      <q-input outlined dense debounce="400" color="primary" v-model="search">-->
      <!--        <template v-slot:append>-->
      <!--          <q-icon name="search"/>-->
      <!--        </template>-->
      <!--      </q-input>-->

      <q-btn flat round dense :icon="props.inFullscreen ? 'fullscreen_exit' : 'fullscreen'"
             @click="props.toggleFullscreen">
        <q-tooltip :disable="$q.platform.is.mobile" v-close-popup>
          {{ props.inFullscreen ? "Exit Fullscreen" : "Toggle Fullscreen" }}
        </q-tooltip>
      </q-btn>
    </template>

    <template v-slot:body-cell-type="props">
      <q-td :props="props">
        <q-chip>{{ props.row.type }}</q-chip>
        â€“
        <q-chip>{{ props.row.type }}</q-chip>
        <!-- <q-btn dense round flat color="grey" @click="deleteRow(props)" icon="delete"></q-btn> -->
      </q-td>
    </template>

    <template v-slot:body-cell-labelIntegrated="props">
      <q-td :props="props">

        <div>
          <span v-if="props.row.edit == null || !props.row.edit">{{ props.row.l }}
            <q-icon @click="props.row.edit=true" size="xs" name="edit"/>
          </span>
          <!-- -->
          <q-input v-else outlined v-model="props.row.l" dense v-on:keyup.enter="props.row.edit = false;">
            <template v-slot:append>
              <q-icon name="o_task_alt" @click.stop.prevent="props.row.edit=false" class="cursor-pointer"/>
            </template>
          </q-input>
          <!-- <input type="text" v-show="props.row.edit == null || props.row.edit"  v-on:keyup.enter="props.row.edit = false;"> -->
        </div>
      </q-td>
    </template>
    <template v-slot:body-cell-actions="props">
      <q-td :props="props">
        <q-btn dense round flat color="grey" @click="deleteRow(props.row)" icon="delete"></q-btn>
      </q-td>
    </template>

    <template v-slot:body-cell-identifier="props">
      <q-td :props="props">
        hola{{ props.row.identifier }}
        <q-checkbox v-model="props.row.identifier" color="teal"/>
      </q-td>
    </template>

    <template v-slot:no-data="{ icon, message, filter }">
      <div class="full-width row flex-center text-accent " style="flex-direction: column">
        <!--        <q-icon size="2em" name="sentiment_dissatisfied"/>-->
        <!-- <span> {{ message }} </span> -->
        <img src="/assets/icons/AlignmentTable.svg" alt="No alignments added" style="width: 320px; height: 176px"/>
        <!-- <svg width="160px" height="88px" viewBox="0 0 216 120" fill="none" xmlns="http://www.w3.org/2000/svg" class="sc-jIkXHa sc-ZOtfp fXAzWm jPTZgW"><g opacity="0.84" clip-path="url(#EmptyDocuments_svg__clip0_1142_57509)"><path fill-rule="evenodd" clip-rule="evenodd" d="M189.25 19.646a7.583 7.583 0 010 15.166h-43.333a7.583 7.583 0 010 15.167h23.833a7.583 7.583 0 010 15.167h-11.022c-5.28 0-9.561 3.395-9.561 7.583 0 1.956 1.063 3.782 3.19 5.48 2.017 1.608 4.824 1.817 7.064 3.096a7.583 7.583 0 01-3.754 14.174H65.75a7.583 7.583 0 010-15.166H23.5a7.583 7.583 0 110-15.167h43.333a7.583 7.583 0 100-15.167H39.75a7.583 7.583 0 110-15.166h43.333a7.583 7.583 0 010-15.167H189.25zm0 30.333a7.583 7.583 0 110 15.166 7.583 7.583 0 010-15.166z" fill="#D9D8FF" fill-opacity="0.8"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M132.561 19.646l10.077 73.496.906 7.374a4.334 4.334 0 01-3.773 4.829l-63.44 7.789a4.333 4.333 0 01-4.83-3.772l-9.767-79.547a2.166 2.166 0 011.91-2.417l5.262-.59 63.655-7.162zM73.162 26.33l4.97-.557-4.97.557z" fill="#fff"></path><path d="M73.162 26.33l4.97-.557m54.429-6.127l10.077 73.496.906 7.374a4.334 4.334 0 01-3.773 4.829l-63.44 7.789a4.333 4.333 0 01-4.83-3.772l-9.767-79.547a2.166 2.166 0 011.91-2.417l5.262-.59 63.655-7.162z" stroke="#7B79FF" stroke-width="2.5"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M129.818 24.27l9.122 66.608.82 6.682c.264 2.153-1.246 4.11-3.373 4.371l-56.812 6.976c-2.127.261-4.066-1.272-4.33-3.425l-8.83-71.908a2.167 2.167 0 011.887-2.415l7.028-.863" fill="#F0F0FF"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M135.331 5.833H85.978a2.97 2.97 0 00-2.107.873A2.97 2.97 0 0083 8.813v82.333c0 .823.333 1.567.872 2.106a2.97 2.97 0 002.107.873h63.917a2.97 2.97 0 002.106-.873 2.97 2.97 0 00.873-2.106V23.367a2.98 2.98 0 00-.873-2.107L137.437 6.705a2.98 2.98 0 00-2.106-.872z" fill="#fff" stroke="#7B79FF" stroke-width="2.5"></path><path d="M135.811 7.082v12.564a3.25 3.25 0 003.25 3.25h8.595M94.644 78.146h28.167m-28.167-55.25h28.167-28.167zm0 13h46.584-46.584zm0 14.083h46.584-46.584zm0 14.084h46.584-46.584z" stroke="#7B79FF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="EmptyDocuments_svg__clip0_1142_57509"><path fill="#fff" d="M0 0h216v120H0z"></path></clipPath></defs></svg> -->
        <p style="color: rgb(102, 102, 135);font-weight: 500;font-size: 1rem;line-height: 1.25;">No alignments added</p>
        <!--

             <q-icon size="2em" :name="filter ? 'filter_b_and_w' : icon"/>-->
      </div>
    </template>
  </q-table>

  <!-- <SelectAlignments :show_dialog="show_dialog" :ds-a="selectedDS[0]" :ds-b="selectedDS[1]"  @close-dialog="show_dialog=false" @add-alignment="addRow"/> -->
  <q-dialog v-model="show_dialog" full-height full-width>
    <ManualAlignmentsForm v-if="alignmentView == 'manual'"
                          @close-dialog="show_dialog=!show_dialog"></ManualAlignmentsForm>
  </q-dialog>


</template>

<script setup>
import {computed, ref, onMounted} from 'vue'
// import SelectAlignments from "components/forms/integration/SelectAlignments.vue";
import {useQuasar} from "quasar";
import ManualAlignmentsForm from 'components/forms/ManualAlignmentsForm.vue';
import {useIntegrationStore} from 'src/stores/integration.store.js'
// import alerts from "components/hooks/alerts"
// -------------------------------------------------------------
//                         PROPS & EMITS
// -------------------------------------------------------------
const props = defineProps({
  no_shadow: {type: Boolean, default: false},
  alignments: {type: Array, default: []}
});
const emit = defineEmits(['update:alignments'])
// -------------------------------------------------------------
//                          STORES & GLOBALS
// -------------------------------------------------------------
const integrationStore = useIntegrationStore()
const $q = useQuasar()
onMounted(() => {
  // TODO: maybe need refactor
  integrationStore.init()
})

// -------------------------------------------------------------
//                          C
// -------------------------------------------------------------
const columns = [
  {name: "uriA", label: "Resource A", align: "center", field: "iriA", sortable: true,},
  {name: "uriB", label: "Resource B", align: "center", field: "iriB", sortable: true,},
  {name: "labelA", label: "Label A", align: "center", field: "labelA", sortable: true,},
  {name: "labelB", label: "Label B", align: "center", field: "labelB", sortable: true,},
  {name: "labelIntegrated", label: "Integrated name", align: "center", field: "l", sortable: true,},
  {name: "type", label: "Type", align: "center", field: "type", sortable: true,},
  {name: "similarity",
    label: "Similarity",
    align: "center",
    field: "similarity",
    sortable: true,
    format: (value) => {
      return `${(value * 100).toFixed(2)}%`;
    },
  },
  {name: "shortType", label: "ShortType", align: "center", field: "shortType", sortable: true,},
  // {name: "identifier", label: "Identifier", align: "center", field: "identifier", sortable: true,},
  {name: "actions", label: "Actions", align: "center", field: "actions", sortable: false,},
];
const visibleCols = ref(['labelA', 'labelB', 'labelIntegrated', 'type','similarity', 'actions'])
const show_dialog = ref(false)
const alignmentView = ref('manual')
// const selectedDS = computed(() => store.state.datasource.selectedDatasources)
const selectedDS = {}
const pagination = ref({rowsPerPage: 0})

// const rows = [];
const title = "Alignments";
// :visible-columns="visibleColumns"
const addRow = (props2) => {
  if (props2) {
    if (props2.row) {
      console.log(props.alignments)
      console.log(props.row)
      console.log(props.alignments.indexOf(props2.row))
      if (props.alignments.indexOf(props2.row) === -1) {
        props.alignments.push(props2.row);
        // console.log(this.items);
      }
      // console.log("emitted")
      // emit("update:alignments", props.alignments )
      // notify.positive(`Alignment ${props2.row.l} added`)
      // console.log(this.rows)
    }
  }
}
const deleteRow = (alignmentRow) => {
  integrationStore.deleteAligment(alignmentRow)
  // props.alignments.splice(props2.rowIndex, 1);
  // emit("update:alignments", props.alignments )
  // emit("alignments", { data: rows          } )
  // this.this.$emit("alignments", { data: this.rows          } )
}
const setManualView = (view) => {
  alignmentView.value = view
  show_dialog.value = true
}
const getAutomaticAlignments = async () => {
  integrationStore.chargingAlignments = true;

  try {
    // Make your asynchronous request here
    await integrationStore.getAlignmentsSurvey();
  } catch (error) {
    // Handle any errors here
  } finally {
  }
};

</script>

<style lang="scss">
#TableAlignments {
  .q-table__middle {
    flex: unset !important;
  }
}

.center {
  margin: auto;
  text-align: center;
  align-items: center;
  vertical-align: middle;
  padding: 90px 0px;
}
</style>
